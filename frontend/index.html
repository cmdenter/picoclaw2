<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>PicoClaw</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0a0a0f;--surface:#12121a;--surface2:#1a1a26;--surface3:#22222e;
  --border:#2a2a3a;--text:#e4e4ef;--text2:#8888a0;--text3:#55556a;
  --accent:#6c5ce7;--accent2:#a29bfe;--accent-glow:rgba(108,92,231,0.15);
  --green:#00e676;--red:#ff5252;--orange:#ffab40;
  --radius:12px;--radius-sm:8px;
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;overflow:hidden}

/* Layout */
#app{display:flex;flex-direction:column;height:100dvh;max-width:860px;margin:0 auto}

/* Header */
header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);background:var(--surface);flex-shrink:0}
.logo{display:flex;align-items:center;gap:8px;font-weight:700;font-size:18px}
.logo svg{width:28px;height:28px}
.status-dot{width:8px;height:8px;border-radius:50%;background:var(--text3);flex-shrink:0}
.status-dot.ok{background:var(--green);box-shadow:0 0 6px var(--green)}
.status-dot.err{background:var(--red)}
.header-actions{display:flex;gap:4px}
.icon-btn{background:none;border:1px solid transparent;color:var(--text2);cursor:pointer;padding:8px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;transition:all .15s}
.icon-btn:hover,.icon-btn:active{background:var(--surface2);color:var(--text);border-color:var(--border)}
.icon-btn svg{width:20px;height:20px}

/* Stats bar */
.stats-bar{display:flex;gap:16px;padding:8px 16px;border-bottom:1px solid var(--border);background:var(--surface);font-size:12px;color:var(--text2);flex-shrink:0;overflow-x:auto}
.stat{display:flex;align-items:center;gap:4px;white-space:nowrap}
.stat b{color:var(--text);font-weight:600}

/* Chat area */
.chat-area{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px;scroll-behavior:smooth}
.chat-area::-webkit-scrollbar{width:4px}
.chat-area::-webkit-scrollbar-track{background:transparent}
.chat-area::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}

/* Messages */
.msg{max-width:85%;padding:10px 14px;border-radius:var(--radius);font-size:14px;line-height:1.55;word-wrap:break-word;white-space:pre-wrap}
.msg.user{align-self:flex-end;background:var(--accent);color:#fff;border-bottom-right-radius:4px}
.msg.assistant{align-self:flex-start;background:var(--surface2);border:1px solid var(--border);border-bottom-left-radius:4px}
.msg.system{align-self:center;background:transparent;color:var(--text3);font-size:12px;text-align:center;padding:4px 12px}
.msg .ts{display:block;font-size:10px;opacity:.5;margin-top:4px}

/* Typing indicator */
.typing{align-self:flex-start;padding:12px 16px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);border-bottom-left-radius:4px;display:none}
.typing.show{display:flex}
.typing span{width:6px;height:6px;background:var(--text3);border-radius:50%;animation:bounce .6s infinite alternate}
.typing span:nth-child(2){animation-delay:.2s}
.typing span:nth-child(3){animation-delay:.4s}
@keyframes bounce{to{opacity:.3;transform:translateY(-4px)}}

/* Input area */
.input-area{padding:12px 16px;border-top:1px solid var(--border);background:var(--surface);flex-shrink:0}
.input-row{display:flex;gap:8px;align-items:flex-end}
textarea{flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);color:var(--text);padding:10px 14px;font-size:14px;font-family:inherit;resize:none;min-height:44px;max-height:120px;line-height:1.4;outline:none;transition:border-color .15s}
textarea:focus{border-color:var(--accent)}
textarea::placeholder{color:var(--text3)}
.send-btn{width:44px;height:44px;border:none;border-radius:var(--radius);background:var(--accent);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .15s}
.send-btn:hover{background:var(--accent2)}
.send-btn:disabled{opacity:.3;cursor:not-allowed}
.send-btn svg{width:20px;height:20px}

/* Settings modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);display:none;align-items:flex-end;justify-content:center;z-index:100}
.modal-overlay.show{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius) var(--radius) 0 0;width:100%;max-width:860px;max-height:80dvh;overflow-y:auto;padding:20px}
.modal h2{font-size:16px;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between}
.modal label{display:block;font-size:12px;color:var(--text2);margin-bottom:4px;margin-top:12px}
.modal input,.modal select{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);padding:10px 12px;font-size:14px;font-family:inherit;outline:none}
.modal input:focus{border-color:var(--accent)}
.btn{padding:10px 20px;border:none;border-radius:var(--radius-sm);font-size:14px;font-weight:600;cursor:pointer;transition:all .15s}
.btn-primary{background:var(--accent);color:#fff}
.btn-primary:hover{background:var(--accent2)}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--text2)}
.btn-outline:hover{border-color:var(--text2);color:var(--text)}
.btn-danger{background:transparent;border:1px solid var(--red);color:var(--red)}
.btn-danger:hover{background:rgba(255,82,82,.1)}
.modal .actions{display:flex;gap:8px;margin-top:20px;flex-wrap:wrap}
.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px 16px;border-radius:var(--radius);font-size:13px;z-index:200;opacity:0;transition:opacity .3s}
.toast.show{opacity:1}
/* PicoMem panel */
.picomem-toggle{display:flex;align-items:center;gap:6px;padding:6px 16px;border-bottom:1px solid var(--border);background:var(--surface);flex-shrink:0}
.picomem-toggle button{padding:4px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);background:transparent;color:var(--text2);font-size:11px;font-weight:600;cursor:pointer;transition:all .15s}
.picomem-toggle button:hover{border-color:var(--accent);color:var(--accent)}
.picomem-toggle button.active{background:var(--accent-glow);border-color:var(--accent);color:var(--accent2)}
.picomem-toggle .mem-label{font-size:11px;color:var(--text3);margin-left:auto}
.picomem{display:none;flex-direction:column;gap:8px;padding:12px 16px;border-bottom:1px solid var(--border);background:var(--bg);max-height:45dvh;overflow-y:auto;flex-shrink:0}
.picomem.show{display:flex}
.picomem::-webkit-scrollbar{width:4px}
.picomem::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
.tier{border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--surface);overflow:hidden}
.tier-head{display:flex;align-items:center;gap:6px;padding:6px 10px;background:var(--surface2);border-bottom:1px solid var(--border);font-size:11px;font-weight:700}
.tier-head .tag{padding:2px 6px;border-radius:4px;font-size:10px;font-weight:700;letter-spacing:.5px}
.tier-head .tag-i{background:rgba(0,230,118,.12);color:var(--green)}
.tier-head .tag-t{background:rgba(108,92,231,.15);color:var(--accent2)}
.tier-head .tag-e{background:rgba(255,171,64,.12);color:var(--orange)}
.tier-head .tag-p{background:rgba(255,82,82,.1);color:var(--red)}
.tier-head .tier-name{color:var(--text2)}
.tier-head .tier-size{margin-left:auto;color:var(--text3);font-weight:400;font-size:10px}
.tier-body{padding:8px 10px;font-size:12px;line-height:1.5;color:var(--text);white-space:pre-wrap;word-break:break-word;min-height:24px;font-family:'SF Mono',Menlo,monospace,monospace}
.tier-body.empty{color:var(--text3);font-style:italic;font-family:inherit}
.picomem-actions{display:flex;gap:6px;margin-top:2px}
.picomem-actions button{padding:4px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);background:transparent;color:var(--text2);font-size:11px;cursor:pointer;transition:all .15s}
.picomem-actions button:hover{border-color:var(--accent);color:var(--accent)}
.picomem-actions button:disabled{opacity:.3;cursor:not-allowed}
.picomem-actions button.danger:hover{border-color:var(--red);color:var(--red)}
.picomem-ts{font-size:10px;color:var(--text3);margin-left:auto;align-self:center}
.hint{font-size:11px;color:var(--text3);margin-top:2px}
.auth-bar{display:flex;align-items:center;gap:6px;position:relative}
.auth-btn{padding:6px 12px;border-radius:var(--radius-sm);font-size:12px;font-weight:600;cursor:pointer;border:1px solid var(--accent);background:transparent;color:var(--accent);transition:all .15s}
.auth-btn:hover{background:var(--accent);color:#fff}
.auth-btn.logout{border-color:var(--border);color:var(--text2)}
.auth-btn.logout:hover{border-color:var(--red);color:var(--red);background:transparent}
.principal-tag{font-size:10px;color:var(--text2);background:var(--surface2);padding:4px 8px;border-radius:var(--radius-sm);font-family:monospace;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.auth-dropdown{position:absolute;top:100%;right:0;margin-top:6px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);overflow:hidden;display:none;z-index:50;min-width:160px;box-shadow:0 8px 24px rgba(0,0,0,.4)}
.auth-dropdown.show{display:block}
.auth-dropdown button{display:flex;align-items:center;gap:8px;width:100%;padding:10px 14px;border:none;background:transparent;color:var(--text);font-size:13px;cursor:pointer;transition:background .15s}
.auth-dropdown button:hover{background:var(--surface2)}
.auth-dropdown button svg{width:18px;height:18px;flex-shrink:0}
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="logo">
      <svg viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="14" stroke="var(--accent)" stroke-width="2"/><circle cx="11" cy="13" r="2.5" fill="var(--accent2)"/><circle cx="21" cy="13" r="2.5" fill="var(--accent2)"/><path d="M10 20c1.5 2.5 4 4 6 4s4.5-1.5 6-4" stroke="var(--accent2)" stroke-width="2" stroke-linecap="round"/></svg>
      <span>PicoClaw</span>
      <span class="status-dot" id="statusDot"></span>
    </div>
    <div class="header-actions">
      <div class="auth-bar" id="authBar">
        <button class="auth-btn" id="authBtn" onclick="toggleAuthDropdown()">Connect</button>
        <div class="auth-dropdown" id="authDropdown">
          <button onclick="loginII()">
            <svg viewBox="0 0 24 24" fill="none" stroke="var(--accent2)" stroke-width="2"><rect x="3" y="11" width="18" height="10" rx="2"/><circle cx="12" cy="16" r="1.5"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
            Internet Identity
          </button>
          <button onclick="loginPlug()">
            <svg viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><path d="M12 2v6m0 8v6M2 12h6m8 0h6"/><circle cx="12" cy="12" r="4"/></svg>
            Plug Wallet
          </button>
        </div>
      </div>
      <button class="icon-btn" onclick="loadHistory()" title="Refresh history">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 4v6h6M23 20v-6h-6"/><path d="M20.49 9A9 9 0 005.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 013.51 15"/></svg>
      </button>
      <button class="icon-btn" onclick="toggleSettings()" title="Settings">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
      </button>
    </div>
  </header>

  <div class="stats-bar" id="statsBar">
    <div class="stat">Messages: <b id="statMsgs">-</b></div>
    <div class="stat">Calls: <b id="statCalls">-</b></div>
    <div class="stat">Cycles: <b id="statCycles">-</b></div>
    <div class="stat">Queue: <b id="statQueue">-</b></div>
  </div>

  <div class="picomem-toggle">
    <button id="memToggleBtn" onclick="toggleMemPanel()">PicoMem</button>
    <span class="mem-label" id="memStatus"></span>
  </div>

  <div class="picomem" id="memPanel">
    <div class="tier">
      <div class="tier-head"><span class="tag tag-i">I</span><span class="tier-name">Identity</span><span class="tier-size" id="tierISize">0/256</span></div>
      <div class="tier-body empty" id="tierI">empty</div>
    </div>
    <div class="tier">
      <div class="tier-head"><span class="tag tag-t">T</span><span class="tier-name">Thread</span><span class="tier-size" id="tierTSize">0/600</span></div>
      <div class="tier-body empty" id="tierT">empty</div>
    </div>
    <div class="tier">
      <div class="tier-head"><span class="tag tag-e">E</span><span class="tier-name">Episodes</span><span class="tier-size" id="tierESize">0/900</span></div>
      <div class="tier-body empty" id="tierE">empty</div>
    </div>
    <div class="tier">
      <div class="tier-head"><span class="tag tag-p">P</span><span class="tier-name">Priors</span><span class="tier-size" id="tierPSize">0/128</span></div>
      <div class="tier-body empty" id="tierP">empty</div>
    </div>
    <div class="picomem-actions">
      <button onclick="refreshMemory()">Refresh</button>
      <button onclick="triggerCompress()" id="compressBtn">Compress Now</button>
      <button class="danger" onclick="clearMemory()" id="clearMemBtn">Clear Memory</button>
      <span class="picomem-ts" id="memTs"></span>
    </div>
  </div>

  <div class="chat-area" id="chatArea">
    <div class="msg system">Connect to your PicoClaw canister to start chatting on-chain.</div>
  </div>

  <div class="typing" id="typing"><span></span><span></span><span></span></div>

  <div class="input-area">
    <div class="input-row">
      <textarea id="input" rows="1" placeholder="Message PicoClaw..." onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
      <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
      </button>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settingsModal">
  <div class="modal">
    <h2>Settings <button class="icon-btn" onclick="toggleSettings()" style="margin:-4px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M18 6L6 18M6 6l12 12"/></svg></button></h2>

    <label>Backend Canister ID</label>
    <input id="cfgCanisterId" placeholder="e.g. rrkah-fqaaa-aaaaa-aaaaq-cai">
    <div class="hint">Your picoclaw canister ID from <code>dfx canister id picoclaw</code></div>

    <label>Network</label>
    <select id="cfgNetwork">
      <option value="ic">Mainnet</option>
    </select>

    <div class="actions">
      <button class="btn btn-primary" onclick="saveSettings()">Save & Connect</button>
      <button class="btn btn-outline" onclick="loadHistory()">Load History</button>
      <button class="btn btn-danger" onclick="clearChat()">Clear Local Chat</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
import { HttpAgent, Actor, Principal, AuthClient } from './dfinity.bundle.js';

// ── Environment detection ────────────────────────────────────────────
const isLocal = window.location.hostname.endsWith('.localhost') || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.port === '4943';

// ── Candid IDL (matches picoclaw.did) ────────────────────────────────
function idlFactory({ IDL }) {
  const Message = IDL.Record({
    role: IDL.Text,
    content: IDL.Text,
    timestamp: IDL.Nat64,
  });
  const Metrics = IDL.Record({
    total_calls: IDL.Nat64,
    total_cycles_spent: IDL.Nat64,
    total_messages: IDL.Nat64,
    errors: IDL.Nat64,
  });
  const PicoState = IDL.Record({
    identity: IDL.Text,
    thread: IDL.Text,
    episodes: IDL.Text,
    priors: IDL.Text,
    updated_at: IDL.Nat64,
    msg_id_at_compress: IDL.Nat64,
  });
  const AgentConfig = IDL.Record({
    persona: IDL.Text,
    system_prompt: IDL.Text,
    allowed_tools: IDL.Vec(IDL.Text),
    api_key: IDL.Opt(IDL.Text),
    model: IDL.Text,
    api_endpoint: IDL.Text,
    max_context_messages: IDL.Nat32,
    max_response_bytes: IDL.Nat64,
    allowed_callers: IDL.Vec(IDL.Principal),
    compress_interval: IDL.Nat32,
  });
  const Result = IDL.Variant({ Ok: IDL.Text, Err: IDL.Text });
  const ResultNull = IDL.Variant({ Ok: IDL.Null, Err: IDL.Text });
  return IDL.Service({
    chat: IDL.Func([IDL.Text], [Result], []),
    get_history: IDL.Func([IDL.Nat64], [IDL.Vec(Message)], ['query']),
    get_metrics: IDL.Func([], [Metrics], ['query']),
    cycle_balance: IDL.Func([], [IDL.Nat], ['query']),
    get_queue_length: IDL.Func([], [IDL.Nat64], ['query']),
    get_notes: IDL.Func([], [PicoState], ['query']),
    clear_notes: IDL.Func([], [ResultNull], []),
    compress_context: IDL.Func([], [Result], []),
    get_config_public: IDL.Func([], [AgentConfig], ['query']),
  });
}

// ── Canister ID detection ────────────────────────────────────────────
function detectCanisterId() {
  const params = new URLSearchParams(window.location.search);
  const qid = params.get('canisterId');
  if (qid) return qid;
  const host = window.location.hostname;
  const match = host.match(/^([a-z0-9-]+)\.(?:raw\.)?(?:localhost|icp0\.io|ic0\.app)/);
  if (match) return match[1];
  return localStorage.getItem('pc_canister_id') || '';
}

// ── State ────────────────────────────────────────────────────────────
let canisterId = detectCanisterId();
let network = isLocal ? 'local' : 'ic';
let sending = false;
let actor = null;
let authClient = null;
let identity = null;
let principalId = null;

// ── Auth ─────────────────────────────────────────────────────────────
let authProvider = null; // 'ii' or 'plug'

function iiUrl() {
  return 'https://identity.ic0.app';
}

async function initAuth() {
  try {
    authClient = await AuthClient.create();
    if (await authClient.isAuthenticated()) {
      identity = authClient.getIdentity();
      principalId = identity.getPrincipal().toText();
      authProvider = 'ii';
      updateAuthUI(true);
      if (canisterId) { await createActor(); checkHealth(); }
    }
  } catch(e) { console.warn('[PicoClaw] II init skipped:', e.message); }
}

function toggleAuthDropdown() {
  if (identity) { logout(); return; }
  document.getElementById('authDropdown').classList.toggle('show');
}

async function loginII() {
  document.getElementById('authDropdown').classList.remove('show');
  if (!authClient) authClient = await AuthClient.create();
  await new Promise((resolve, reject) => {
    authClient.login({
      identityProvider: iiUrl(),
      maxTimeToLive: BigInt(8) * BigInt(3_600_000_000_000),
      onSuccess: resolve,
      onError: reject,
    });
  });
  identity = authClient.getIdentity();
  principalId = identity.getPrincipal().toText();
  authProvider = 'ii';
  updateAuthUI(true);
  toast('II connected: ' + principalId.slice(0, 8) + '...');
  if (canisterId) { await createActor(); checkHealth(); loadHistory(); }
}

async function loginPlug() {
  document.getElementById('authDropdown').classList.remove('show');
  if (!window.ic || !window.ic.plug) {
    toast('Plug wallet not found. Install the Plug extension.');
    window.open('https://plugwallet.ooo/', '_blank');
    return;
  }
  try {
    const whitelist = canisterId ? [canisterId] : [];
    const host = icHost();
    await window.ic.plug.requestConnect({ whitelist, host });
    const p = await window.ic.plug.agent.getPrincipal();
    principalId = p.toText();
    identity = { getPrincipal: () => p, _plug: true };
    authProvider = 'plug';
    updateAuthUI(true);
    toast('Plug connected: ' + principalId.slice(0, 8) + '...');
    await createActorPlug();
    if (actor) { checkHealth(); loadHistory(); }
  } catch(e) {
    console.error('Plug login failed:', e);
    toast('Plug connection failed');
  }
}

async function createActorPlug() {
  if (!canisterId || !window.ic?.plug) return null;
  try {
    actor = await window.ic.plug.createActor({ canisterId, interfaceFactory: idlFactory });
    return actor;
  } catch(e) {
    console.error('Plug actor failed:', e);
    actor = null;
    return null;
  }
}

async function logout() {
  if (authProvider === 'plug' && window.ic?.plug) {
    try { await window.ic.plug.disconnect(); } catch(_) {}
  }
  if (authProvider === 'ii' && authClient) {
    await authClient.logout();
  }
  identity = null;
  principalId = null;
  actor = null;
  authProvider = null;
  updateAuthUI(false);
  document.getElementById('statusDot').className = 'status-dot';
  toast('Disconnected');
}

function updateAuthUI(authenticated) {
  const bar = document.getElementById('authBar');
  const dropdown = document.getElementById('authDropdown');
  if (authenticated && principalId) {
    const short = principalId.slice(0, 5) + '...' + principalId.slice(-3);
    const label = authProvider === 'plug' ? 'Plug' : 'II';
    bar.querySelector('.auth-btn').outerHTML = `<span class="principal-tag" title="${principalId}">${label}: ${short}</span><button class="auth-btn logout" onclick="toggleAuthDropdown()">Disconnect</button>`;
    if (dropdown) dropdown.classList.remove('show');
  } else {
    const btn = bar.querySelector('.auth-btn');
    if (btn) btn.outerHTML = '<button class="auth-btn" onclick="toggleAuthDropdown()">Connect</button>';
    const tag = bar.querySelector('.principal-tag');
    if (tag) tag.remove();
  }
}

// Close dropdown when clicking outside
document.addEventListener('click', (e) => {
  const dd = document.getElementById('authDropdown');
  const bar = document.getElementById('authBar');
  if (dd && bar && !bar.contains(e.target)) dd.classList.remove('show');
});

// ── Actor ────────────────────────────────────────────────────────────
function icHost() {
  if (isLocal) return 'http://127.0.0.1:4943';
  return 'https://icp-api.io';
}

async function createActor() {
  if (!canisterId) return null;
  try {
    const agent = new HttpAgent({ host: icHost() });
    if (isLocal) {
      agent.fetchRootKey().catch(() => {});
    }
    actor = Actor.createActor(idlFactory, { agent, canisterId });
    return actor;
  } catch (e) {
    console.error('Failed to create actor:', e);
    actor = null;
    return null;
  }
}

// ── Health check (free query) ────────────────────────────────────────
async function checkHealth() {
  const dot = document.getElementById('statusDot');
  try {
    if (!actor) await createActor();
    if (!actor) throw new Error('No actor');
    await actor.cycle_balance();
    dot.className = 'status-dot ok';
    refreshMetrics();
  } catch {
    dot.className = 'status-dot err';
  }
}

// ── Metrics (all free queries) ───────────────────────────────────────
async function refreshMetrics() {
  if (!actor) return;
  try {
    const [m, bal, q] = await Promise.all([
      actor.get_metrics(),
      actor.cycle_balance(),
      actor.get_queue_length(),
    ]);
    document.getElementById('statMsgs').textContent = m.total_messages.toString();
    document.getElementById('statCalls').textContent = m.total_calls.toString();
    document.getElementById('statQueue').textContent = q.toString();
    const t = Number(bal) / 1e12;
    document.getElementById('statCycles').textContent = t.toFixed(2) + 'T';
  } catch {}
}

// ── History (authenticated query) ────────────────────────────────────
async function loadHistory() {
  if (!actor) { toast('Connect first'); return; }
  if (!identity) { toast('Login first'); return; }
  try {
    const msgs = await actor.get_history(BigInt(200));
    const area = document.getElementById('chatArea');
    area.innerHTML = '';
    if (msgs.length === 0) {
      area.innerHTML = '<div class="msg system">No messages yet. Start chatting!</div>';
    }
    msgs.forEach(m => addMessage(m.role, m.content, m.timestamp));
    scrollBottom();
    toast('History loaded');
  } catch (e) {
    toast('Failed: ' + e.message);
  }
}

// ── Chat (authenticated update call) ─────────────────────────────────
async function sendMessage() {
  const input = document.getElementById('input');
  const text = input.value.trim();
  if (!text || sending) return;
  if (!identity) { toast('Connect a wallet first'); return; }
  if (!actor) { toggleSettings(); toast('Set canister ID first'); return; }

  sending = true;
  input.value = '';
  autoResize(input);
  updateSendBtn();
  addMessage('user', text);
  scrollBottom();
  showTyping(true);

  try {
    const result = await actor.chat(text);
    showTyping(false);
    if ('Ok' in result) {
      addMessage('assistant', result.Ok);
    } else {
      addMessage('system', 'Error: ' + result.Err);
    }
    refreshMetrics();
    // Refresh memory panel after chat (compression may have triggered)
    if (memPanelOpen) setTimeout(refreshMemory, 1500);
  } catch (e) {
    showTyping(false);
    addMessage('system', 'Call failed: ' + e.message);
  }
  sending = false;
  scrollBottom();
  updateSendBtn();
}

// ── UI helpers ───────────────────────────────────────────────────────
function addMessage(role, content, timestamp) {
  const area = document.getElementById('chatArea');
  const div = document.createElement('div');
  div.className = `msg ${role}`;
  div.textContent = content;
  if (timestamp) {
    const ts = document.createElement('span');
    ts.className = 'ts';
    const d = new Date(Number(timestamp) / 1e6);
    ts.textContent = d.toLocaleTimeString();
    div.appendChild(ts);
  }
  area.appendChild(div);
}

function scrollBottom() {
  const area = document.getElementById('chatArea');
  requestAnimationFrame(() => area.scrollTop = area.scrollHeight);
}

function showTyping(show) {
  const el = document.getElementById('typing');
  const area = document.getElementById('chatArea');
  if (show) { area.appendChild(el); el.classList.add('show'); }
  else { el.classList.remove('show'); }
  scrollBottom();
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
  updateSendBtn();
}

function updateSendBtn() {
  document.getElementById('sendBtn').disabled = !document.getElementById('input').value.trim() || sending;
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}

function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2500);
}

// ── PicoMem panel ────────────────────────────────────────────────
let memPanelOpen = false;

function toggleMemPanel() {
  memPanelOpen = !memPanelOpen;
  document.getElementById('memPanel').classList.toggle('show', memPanelOpen);
  document.getElementById('memToggleBtn').classList.toggle('active', memPanelOpen);
  if (memPanelOpen && actor) refreshMemory();
}

function renderTier(elId, sizeElId, text, maxChars) {
  const body = document.getElementById(elId);
  const size = document.getElementById(sizeElId);
  if (text && text.length > 0) {
    body.textContent = text;
    body.className = 'tier-body';
  } else {
    body.textContent = 'empty';
    body.className = 'tier-body empty';
  }
  size.textContent = (text ? text.length : 0) + '/' + maxChars;
}

async function refreshMemory() {
  if (!actor) return;
  try {
    const state = await actor.get_notes();
    renderTier('tierI', 'tierISize', state.identity, 256);
    renderTier('tierT', 'tierTSize', state.thread, 600);
    renderTier('tierE', 'tierESize', state.episodes, 900);
    renderTier('tierP', 'tierPSize', state.priors, 128);

    // Update timestamp
    const ts = document.getElementById('memTs');
    if (state.updated_at > 0n) {
      const d = new Date(Number(state.updated_at) / 1e6);
      ts.textContent = 'updated ' + d.toLocaleTimeString();
    } else {
      ts.textContent = 'never compressed';
    }

    // Update status label
    const filled = [state.identity, state.thread, state.episodes, state.priors].filter(s => s.length > 0).length;
    document.getElementById('memStatus').textContent = filled + '/4 tiers';
  } catch (e) {
    toast('Memory fetch failed: ' + e.message);
  }
}

async function triggerCompress() {
  if (!actor || !identity) { toast('Login first'); return; }
  const btn = document.getElementById('compressBtn');
  btn.disabled = true;
  btn.textContent = 'Compressing...';
  try {
    const result = await actor.compress_context();
    if ('Ok' in result) {
      toast('Compression complete');
      await refreshMemory();
    } else {
      toast('Compress error: ' + result.Err);
    }
  } catch (e) {
    toast('Compress failed: ' + e.message);
  }
  btn.disabled = false;
  btn.textContent = 'Compress Now';
}

async function clearMemory() {
  if (!actor || !identity) { toast('Login first'); return; }
  if (!confirm('Clear all PicoMem tiers? This cannot be undone.')) return;
  try {
    const result = await actor.clear_notes();
    if ('Ok' in result) {
      toast('Memory cleared');
      await refreshMemory();
    } else {
      toast('Clear error: ' + result.Err);
    }
  } catch (e) {
    toast('Clear failed: ' + e.message);
  }
}

// ── Settings ─────────────────────────────────────────────────────────
function toggleSettings() {
  const modal = document.getElementById('settingsModal');
  modal.classList.toggle('show');
  if (modal.classList.contains('show')) {
    document.getElementById('cfgCanisterId').value = canisterId;
    document.getElementById('cfgNetwork').value = network;
  }
}

function saveSettings() {
  canisterId = document.getElementById('cfgCanisterId').value.trim();
  network = document.getElementById('cfgNetwork').value;
  localStorage.setItem('pc_canister_id', canisterId);
  localStorage.setItem('pc_network', network);
  toggleSettings();
  toast('Connecting...');
  if (canisterId) { createActor().then(() => checkHealth()); }
}

function clearChat() {
  document.getElementById('chatArea').innerHTML =
    '<div class="msg system">Chat cleared. On-chain history is unchanged.</div>';
  toast('Local chat cleared');
}

// ── Wire up handlers (module scope → window) ─────────────────────────
window.sendMessage = sendMessage;
window.loadHistory = loadHistory;
window.toggleSettings = toggleSettings;
window.saveSettings = saveSettings;
window.clearChat = clearChat;
window.handleKey = handleKey;
window.autoResize = autoResize;
window.toggleAuthDropdown = toggleAuthDropdown;
window.loginII = loginII;
window.loginPlug = loginPlug;
window.toggleMemPanel = toggleMemPanel;
window.refreshMemory = refreshMemory;
window.triggerCompress = triggerCompress;
window.clearMemory = clearMemory;

document.getElementById('input').addEventListener('input', updateSendBtn);

// ── Init ─────────────────────────────────────────────────────────────
try {
  await initAuth();
  if (canisterId && identity) {
    await createActor();
    checkHealth();
    loadHistory();
    refreshMemory();
  }
} catch(e) {
  console.error('[PicoClaw] Init error:', e);
  document.title = 'ERROR: ' + e.message;
}
setInterval(refreshMetrics, 30000);
</script>
</body>
</html>
